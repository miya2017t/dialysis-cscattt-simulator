<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>透析室防災 CSCATTT 訓練</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}
button {
  cursor: pointer;
  border: none;
  border-radius: 12px;
  padding: 12px 16px;
  font-weight: bold;
}
.hidden { display: none; }
.card {
  background: #111827;
  border-radius: 16px;
  padding: 20px;
  margin: 16px auto;
  max-width: 720px;
}
textarea {
  width: 100%;
  min-height: 140px;
  border-radius: 12px;
  border: none;
  padding: 12px;
  font-size: 14px;
}
.progress {
  height: 6px;
  background: #1e293b;
  border-radius: 6px;
  overflow: hidden;
}
.progress > div {
  height: 100%;
  background: #3b82f6;
}
.small { font-size: 12px; color: #94a3b8; }
</style>
</head>

<body>

<div id="app"></div>

<script>
/* ====== データ ====== */

const situations = [
  { id: "fire", label: "火災" },
  { id: "earthquake", label: "地震" },
  { id: "flood", label: "水害" }
];

const roles = [
  "センター長","フロア責任者","主任","副主任","技士","その他"
];

const scenario = [
  { id:"Command", title:"Command（指揮・統制）", intent:"指揮系統を明確にする" },
  { id:"Safety", title:"Safety（安全確保）", intent:"自身と現場の安全確認" },
  { id:"Communication", title:"Communication（情報伝達）", intent:"必要な情報を正確に伝える" },
  { id:"Assessment", title:"Assessment（評価）", intent:"被害と状況を把握する" },
  { id:"Triage", title:"Triage（トリアージ）", intent:"優先順位を決める" },
  { id:"Treatment", title:"Treatment（応急処置）", intent:"最低限の処置を行う" },
  { id:"Transport", title:"Transport（搬送）", intent:"安全な場所へ移動させる" }
];

/* ====== 状態 ====== */

let step = "landing";
let selectedSituations = [];
let role = "";
let index = 0;
let answers = {};
let hintsUsed = 0;
let showHint = false;
let copyStatus = "コピーする";

/* ====== ユーティリティ ====== */

const app = document.getElementById("app");

function render(html) {
  app.innerHTML = html;
}

function situationLabel() {
  return selectedSituations.map(s => s.label).join("＋");
}

/* ====== ログ生成 ====== */

function buildLog() {
  const now = new Date().toLocaleString("ja-JP");
  let log = `【透析室災害シミュレーション・思考ログ】\n`;
  log += `実施日時：${now}\n`;
  log += `状況：${situationLabel()} / 役割：${role}\n`;
  log += `----------------------------------\n`;
  scenario.forEach(s=>{
    log += `■ ${s.title}\n`;
    log += `思考：${answers[s.id] || "(未入力)"}\n\n`;
  });
  log += `----------------------------------\n\n`;
  log += `【AIへのフィードバック依頼プロンプト】\n`;
  log += `あなたは採点者・審査員・評価者ではありません。\n`;
  log += `この訓練は正解探しではなく、思考過程の整理が目的です。\n\n`;
  log += `禁止事項：点数化・良否判定・模範解答提示\n\n`;
  log += `役割：思考を映す鏡として、視点・気づき・問いを提示してください。\n\n`;
  scenario.forEach(s=>{
    log += `[${s.id}] ${answers[s.id]}\n`;
  });
  return log;
}

/* ====== 画面 ====== */

function landing() {
  render(`
    <div class="card">
      <h1>透析室防災 CSCATTT 訓練</h1>
      <p class="small">思考を言語化し、AIと対話する防災訓練</p>
      <button onclick="step='situation'; draw()">開始</button>
    </div>
  `);
}

function selectSituation() {
  render(`
    <div class="card">
      <h2>災害状況を選択</h2>
      ${situations.map(s=>`
        <button onclick="selectedSituations=[${JSON.stringify(s)}]; draw()">${s.label}</button>
      `).join("<br><br>")}
      <br><br>
      <button onclick="randomSituation()">ランダム（複合あり）</button>
      <br><br>
      <button onclick="step='role'; draw()" ${selectedSituations.length===0?"disabled":""}>次へ</button>
    </div>
  `);
}

function randomSituation() {
  const shuffled = [...situations].sort(()=>0.5-Math.random());
  selectedSituations = shuffled.slice(0, Math.random()<0.6 ? 2 : 1);
  draw();
}

function selectRole() {
  render(`
    <div class="card">
      <h2>${situationLabel()} シナリオ</h2>
      <h3>あなたの役割</h3>
      ${roles.map(r=>`
        <button onclick="role='${r}'; step='sim'; draw()">${r}</button>
      `).join("<br><br>")}
    </div>
  `);
}

function simulation() {
  const s = scenario[index];
  const progress = ((index+1)/scenario.length)*100;
  render(`
    <div class="card">
      <div class="progress"><div style="width:${progress}%"></div></div>
      <h3>${s.title}</h3>
      <p class="small">${s.intent}</p>
      <textarea id="input">${answers[s.id]||""}</textarea>
      <br><br>
      <button onclick="next()">次へ</button>
    </div>
  `);
}

function next() {
  const val = document.getElementById("input").value;
  answers[scenario[index].id] = val;
  index++;
  if(index>=scenario.length){
    step="result";
  }
  draw();
}

function result() {
  render(`
    <div class="card">
      <h2>完了</h2>
      <button onclick="copy()">ログをコピー</button>
      <p id="status">${copyStatus}</p>
      <pre class="small">${buildLog()}</pre>
    </div>
  `);
}

function copy() {
  navigator.clipboard.writeText(buildLog());
  copyStatus = "コピー完了！";
  draw();
}

/* ====== ルーティング ====== */

function draw() {
  if(step==="landing") landing();
  if(step==="situation") selectSituation();
  if(step==="role") selectRole();
  if(step==="sim") simulation();
  if(step==="result") result();
}

draw();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>透析室防災 CSCATTT 訓練</title>

  <!-- React CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-slate-900">
  <div id="root"></div>

<script type="text/babel">
const { useState } = React;

/* ---------------- データ ---------------- */

const baseSituations = {
  fire: { label: "火災", icons: ["flame"] },
  earthquake: { label: "地震", icons: ["zap"] },
  flood: { label: "水害", icons: ["waves"] }
};

const combinedSituations = [
  { id: "fire-earthquake", types: ["fire","earthquake"] },
  { id: "earthquake-flood", types: ["earthquake","flood"] },
  { id: "fire-flood", types: ["fire","flood"] }
];

const scenario = [
  { id:"Command", title:"Command" },
  { id:"Safety", title:"Safety" },
  { id:"Communication", title:"Communication" },
  { id:"Assessment", title:"Assessment" },
  { id:"Triage", title:"Triage" },
  { id:"Treatment", title:"Treatment" },
  { id:"Transport", title:"Transport" }
];

/* ---------------- App ---------------- */

function App() {
  const [step, setStep] = useState("start");
  const [situation, setSituation] = useState(null);
  const [index, setIndex] = useState(0);
  const [answers, setAnswers] = useState({});
  const [input, setInput] = useState("");
  const [hintsUsed, setHintsUsed] = useState(0);
  const [hintHistory, setHintHistory] = useState([]);
  const [showHint, setShowHint] = useState(false);
  const [copyStatus, setCopyStatus] = useState("コピーする");

  /* ---- ランダム（必ず複合） ---- */
  const randomSituation = () => {
    const r = combinedSituations[Math.floor(Math.random()*combinedSituations.length)];
    setSituation(r);
    setStep("sim");
  };

  /* ---- 次へ ---- */
  const next = () => {
    setAnswers({...answers, [scenario[index].id]: input});
    setInput("");
    setShowHint(false);
    if(index < scenario.length-1) setIndex(index+1);
    else setStep("result");
  };

  /* ---- コピー ---- */
  const copy = async () => {
    let text = "【思考ログ】\n";
    scenario.forEach(s=>{
      text += `■${s.title}\n${answers[s.id] || ""}\n\n`;
    });
    await navigator.clipboard.writeText(text);
    setCopyStatus("✅ コピーしました");
    setTimeout(()=>setCopyStatus("コピーする"),2000);
  };

  /* ---------------- 表示 ---------------- */

  if(step==="start"){
    return (
      <div className="min-h-screen flex flex-col items-center justify-center text-white space-y-6">
        <h1 className="text-3xl font-bold">透析室防災 CSCATTT</h1>
        <button onClick={randomSituation}
          className="px-6 py-4 bg-blue-600 rounded-xl font-bold">
          ランダム（複合災害）で始める
        </button>
      </div>
    );
  }

  if(step==="sim"){
    const s = scenario[index];
    return (
      <div className="min-h-screen bg-slate-50 p-6">
        <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow space-y-4">
          <div className="flex gap-2">
            {situation.types.map(t =>
              baseSituations[t].icons.map(i =>
                <i data-lucide={i} key={t+i}></i>
              )
            )}
            <span className="font-bold">
              {situation.types.map(t=>baseSituations[t].label).join("＋")}
            </span>
          </div>

          <h2 className="text-xl font-bold">{s.title}</h2>

          {!showHint ? (
            <button
              disabled={hintsUsed>=2}
              onClick={()=>{
                setShowHint(true);
                setHintsUsed(hintsUsed+1);
                setHintHistory([...hintHistory, s.title]);
              }}
              className={`w-full py-2 rounded ${
                hintsUsed<2 ? "bg-amber-200" : "bg-slate-200 text-slate-400"
              }`}
            >
              ヒントを使う（残り {2-hintsUsed} 回）
            </button>
          ) : (
            <div className="bg-amber-50 p-3 rounded text-sm">
              ※ 思考を一段深くする視点を意識してください
            </div>
          )}

          <textarea
            value={input}
            onChange={e=>setInput(e.target.value)}
            className="w-full min-h-[150px] border p-3 rounded"
            placeholder="今考えることを書いてください"
          />

          <button onClick={next}
            className="w-full py-3 bg-blue-600 text-white rounded font-bold">
            次へ
          </button>
        </div>
      </div>
    );
  }

  if(step==="result"){
    return (
      <div className="min-h-screen bg-slate-50 p-6">
        <div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow space-y-4">
          <h2 className="text-xl font-bold">完了</h2>

          <p className="text-sm text-slate-500">
            ヒント使用：{hintHistory.join(" / ") || "未使用"}
          </p>

          <button onClick={copy}
            className={`px-6 py-3 rounded text-white font-bold
              ${copyStatus!=="コピーする" ? "bg-green-600" : "bg-blue-600"}`}>
            {copyStatus}
          </button>

          <button onClick={()=>location.reload()}
            className="block text-sm text-slate-400 mt-4">
            最初からやり直す
          </button>
        </div>
      </div>
    );
  }
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
lucide.createIcons();
</script>
</body>
</html>
